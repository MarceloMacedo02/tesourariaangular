<!-- Start Breadcrumbs -->
<app-breadcrumbs [title]="isEditing ? 'Editar Sócio' : 'Novo Sócio'"
    [breadcrumbItems]="breadCrumbItems"></app-breadcrumbs>
<!-- End Breadcrumbs -->

<!-- Toast Notification -->
<div *ngIf="toastMessage()" class="toast show position-fixed top-0 end-0 m-3" role="alert" aria-live="assertive"
    aria-atomic="true" style="z-index: 9999;">
    <div class="toast-header" [ngClass]="getToastClasses(toastType())">
        <strong class="me-auto" *ngIf="toastType() === 'success'">Sucesso</strong>
        <strong class="me-auto" *ngIf="toastType() === 'error'">Erro</strong>
        <strong class="me-auto" *ngIf="toastType() === 'warning'">Aviso</strong>
        <strong class="me-auto" *ngIf="toastType() === 'info'">Informação</strong>
        <button type="button" class="btn-close btn-close-white" (click)="toastMessage.set(null)"
            aria-label="Close"></button>
    </div>
    <div class="toast-body" [ngClass]="getToastClasses(toastType())">
        {{ toastMessage() }}
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">{{ isEditing ? 'Editar Sócio' : 'Novo Sócio' }}</h4>
            </div>
            <div class="card-body">
                <form (ngSubmit)="onSubmit()" #socioForm="ngForm">

                    <!-- Abas para organizar os dados -->
                    <ul class="nav nav-tabs nav-tabs-custom nav-justified" role="tablist">
                        <li class="nav-item">
                            <a class="nav-link" [class.active]="activeTab === 'dados-pessoais'"
                                (click)="activeTab = 'dados-pessoais'" role="tab" style="cursor: pointer;">
                                <span class="d-block d-sm-none">Dados Pessoais</span>
                                <span class="d-none d-sm-block">Dados Pessoais</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" [class.active]="activeTab === 'enderecos'"
                                (click)="activeTab = 'enderecos'" role="tab" style="cursor: pointer;">
                                <span class="d-block d-sm-none">Endereços</span>
                                <span class="d-none d-sm-block">Endereços</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" [class.active]="activeTab === 'dados-socio'"
                                (click)="activeTab = 'dados-socio'" role="tab" style="cursor: pointer;">
                                <span class="d-block d-sm-none">Sócio</span>
                                <span class="d-none d-sm-block">Dados de Sócio</span>
                            </a>
                        </li>
                        <li class="nav-item">
                            <a class="nav-link" [class.active]="activeTab === 'dependentes'"
                                (click)="activeTab = 'dependentes'" role="tab" style="cursor: pointer;">
                                <span class="d-block d-sm-none">Dependentes</span>
                                <span class="d-none d-sm-block">Dependentes</span>
                            </a>
                        </li>
                    </ul>

                    <div class="tab-content p-4">
                        <!-- Dados Pessoais -->
                        <div class="tab-pane" [class.active]="activeTab === 'dados-pessoais'"
                            [class.show]="activeTab === 'dados-pessoais'">
                            <div class="row g-3">
                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="nomeSocio" class="form-label">
                                            Nome Completo *
                                        </label>
                                        <input type="text" class="form-control" id="nomeSocio" name="nomeSocio"
                                            [(ngModel)]="socio.nomeSocio" [disabled]="loading" required maxlength="100"
                                            placeholder="Informe o nome completo">
                                    </div>
                                </div>

                                <div class="col-lg-3">
                                    <div class="mb-3">
                                        <label for="cpf" class="form-label">
                                            CPF *
                                        </label>
                                        <input type="text" class="form-control" id="cpf" name="cpf"
                                            [(ngModel)]="socio.cpf" [disabled]="loading" placeholder="000.000.000-00"
                                            maxlength="14" (input)="socio.cpf = formatCpf(socio.cpf || '')">
                                    </div>
                                </div>

                                <div class="col-lg-3">
                                    <div class="mb-3">
                                        <label for="grau" class="form-label">
                                            Grau do Sócio *
                                        </label>
                                        <ng-select [(ngModel)]="socio.grau" name="grau"
                                            [disabled]="loading || loadingImage" [clearable]="false" [searchable]="true"
                                            [closeOnSelect]="true" placeholder="Selecione o grau do sócio"
                                            [items]="grausSocios" bindValue="name" bindLabel="descricao" required>
                                        </ng-select>
                                    </div>
                                </div>

                                <div class="col-lg-4">
                                    <div class="mb-3">
                                        <label for="dataNascimento" class="form-label">
                                            Data de Nascimento
                                        </label>
                                        <input type="text" class="form-control" id="dataNascimento"
                                            name="dataNascimento" [(ngModel)]="socio.dataNascimento"
                                            [disabled]="loading" placeholder="dd/mm/aaaa" mwlFlatpickr [altInput]="true"
                                            [convertModelValue]="true" [dateFormat]="'Y-m-d'" altFormat="d/m/Y">
                                    </div>
                                </div>

                                <div class="col-lg-4">
                                    <div class="mb-3">
                                        <label for="diaNascimento" class="form-label">
                                            Dia de Nascimento
                                        </label>
                                        <input type="number" class="form-control" id="diaNascimento"
                                            name="diaNascimento" [(ngModel)]="socio.diaNascimento" [disabled]="loading"
                                            placeholder="Ex: 15">
                                    </div>
                                </div>

                                <div class="col-lg-4">
                                    <div class="mb-3">
                                        <label for="mesNascimento" class="form-label">
                                            Mês de Nascimento
                                        </label>
                                        <input type="number" class="form-control" id="mesNascimento"
                                            name="mesNascimento" [(ngModel)]="socio.mesNascimento" [disabled]="loading"
                                            placeholder="Ex: 8">
                                    </div>
                                </div>

                                <div class="col-lg-4">
                                    <div class="mb-3">
                                        <label for="celular" class="form-label">
                                            Celular
                                        </label>
                                        <input type="text" class="form-control" id="celular" name="celular"
                                            [(ngModel)]="socio.celular" [disabled]="loading"
                                            placeholder="(00) 90000-0000" maxlength="15"
                                            (input)="socio.celular = formatCelular(socio.celular || '')">
                                    </div>
                                </div>

                                <div class="col-lg-4">
                                    <div class="mb-3">
                                        <label for="telefoneResidencial" class="form-label">
                                            Telefone Residencial
                                        </label>
                                        <input type="text" class="form-control" id="telefoneResidencial"
                                            name="telefoneResidencial" [(ngModel)]="socio.telefoneResidencial"
                                            [disabled]="loading" placeholder="(00) 0000-0000" maxlength="14"
                                            (input)="socio.telefoneResidencial = formatTelefoneResidencial(socio.telefoneResidencial || '')">
                                    </div>
                                </div>

                                <div class="col-lg-4">
                                    <div class="mb-3">
                                        <label for="email" class="form-label">
                                            Email
                                        </label>
                                        <input type="email" class="form-control" id="email" name="email"
                                            [(ngModel)]="socio.email" [disabled]="loading"
                                            placeholder="email@exemplo.com">
                                    </div>
                                </div>

                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <label for="emailAlternativo" class="form-label">
                                            Email Alternativo
                                        </label>
                                        <input type="email" class="form-control" id="emailAlternativo"
                                            name="emailAlternativo" [(ngModel)]="socio.emailAlternativo"
                                            [disabled]="loading" placeholder="email.alternativo@exemplo.com">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Endereços -->
                        <div class="tab-pane" [class.active]="activeTab === 'enderecos'"
                            [class.show]="activeTab === 'enderecos'">
                            <div class="row g-3">
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <label for="enderecoResidencial" class="form-label">
                                            Endereço Residencial
                                        </label>
                                        <textarea class="form-control" id="enderecoResidencial"
                                            name="enderecoResidencial" [(ngModel)]="socio.enderecoResidencial"
                                            [disabled]="loading" maxlength="500" rows="2"
                                            placeholder="Rua, número, bairro, cidade - estado">
                                        </textarea>
                                    </div>
                                </div>

                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <label for="enderecoComercial" class="form-label">
                                            Endereço Comercial
                                        </label>
                                        <textarea class="form-control" id="enderecoComercial" name="enderecoComercial"
                                            [(ngModel)]="socio.enderecoComercial" [disabled]="loading" maxlength="500"
                                            rows="2" placeholder="Rua, número, bairro, cidade - estado">
                                        </textarea>
                                    </div>
                                </div>

                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <label for="enderecoOutro" class="form-label">
                                            Outro Endereço
                                        </label>
                                        <textarea class="form-control" id="enderecoOutro" name="enderecoOutro"
                                            [(ngModel)]="socio.enderecoOutro" [disabled]="loading" maxlength="500"
                                            rows="2" placeholder="Rua, número, bairro, cidade - estado">
                                        </textarea>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Dados do Sócio -->
                        <div class="tab-pane" [class.active]="activeTab === 'dados-socio'"
                            [class.show]="activeTab === 'dados-socio'">
                            <div class="row g-3">
                                <!-- Upload de foto/avatar -->
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <label for="avatarUpload" class="form-label">Foto do Sócio</label>

                                    </div>
                                </div>

                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="status" class="form-label">
                                            Status
                                        </label>
                                        <ng-select [(ngModel)]="socio.status" name="status" [disabled]="loading"
                                            [clearable]="true" [searchable]="true" [closeOnSelect]="true"
                                            placeholder="Selecione o status do sócio" [items]="statusSocios"
                                            bindValue="name" bindLabel="descricao">
                                        </ng-select>
                                    </div>
                                </div>

                                <div class="col-lg-6">
                                    <div class="mb-3">
                                        <label for="grupoMensalidadeId" class="form-label">
                                            Grupo de Mensalidade
                                        </label>
                                        <ng-select [(ngModel)]="socio.grupoMensalidadeId" name="grupoMensalidadeId"
                                            [disabled]="loading" [clearable]="true" [searchable]="true"
                                            [closeOnSelect]="true" placeholder="Selecione um grupo de mensalidade"
                                            [items]="gruposMensalidade" bindValue="id" bindLabel="nomeGrupoMensalidade">
                                        </ng-select>
                                    </div>
                                </div>

                                <div class="col-lg-3">
                                    <div class="mb-3">
                                        <label for="dataAdesao" class="form-label">
                                            Data de Adesão
                                        </label>
                                        <input type="text" class="form-control" id="dataAdesao" name="dataAdesao"
                                            [(ngModel)]="socio.dataAdesao" [disabled]="loading" placeholder="dd/mm/aaaa"
                                            mwlFlatpickr [altInput]="true" [convertModelValue]="true"
                                            [dateFormat]="'Y-m-d'" altFormat="d/m/Y">
                                    </div>
                                </div>

                                <div class="col-lg-3">
                                    <div class="mb-3">
                                        <label class="form-label">
                                            Ativo
                                        </label>
                                        <div class="form-check form-switch">
                                            <input type="checkbox" class="form-check-input" id="ativo" name="ativo"
                                                [(ngModel)]="socio.ativo" [disabled]="loading">
                                            <label class="form-check-label" for="ativo">
                                                {{ socio.ativo ? 'Ativo' : 'Inativo' }}
                                            </label>
                                        </div>
                                    </div>
                                </div>


                            </div>
                        </div>

                        <!-- Dependentes -->
                        <div class="tab-pane" [class.active]="activeTab === 'dependentes'"
                            [class.show]="activeTab === 'dependentes'">
                            <div class="row g-3">
                                <div class="col-lg-12">
                                    <div class="mb-3">
                                        <label class="form-label">Dependentes</label>
                                        <div class="table-responsive">
                                            <table class="table table-striped table-nowrap align-middle mb-0">
                                                <thead>
                                                    <tr>
                                                        <th>ID</th>
                                                        <th>Nome</th>
                                                        <th>Grau</th>
                                                        <th>Ações</th>
                                                    </tr>
                                                </thead>
                                                <tbody>
                                                    <tr *ngFor="let dependente of socio.dependentes; let i = index">
                                                        <td>{{ dependente.id }}</td>
                                                        <td>{{ dependente.nomeSocio }}</td>
                                                        <td>{{ dependente.grau || 'N/A' }}</td>
                                                        <td>
                                                            <button type="button" class="btn btn-danger btn-sm"
                                                                (click)="removerDependente(i)">
                                                                <i class="ri-delete-bin-line"></i>
                                                            </button>
                                                        </td>
                                                    </tr>
                                                    <tr *ngIf="!socio.dependentes || socio.dependentes.length === 0">
                                                        <td colspan="4" class="text-center">Nenhum dependente cadastrado
                                                        </td>
                                                    </tr>
                                                </tbody>
                                            </table>
                                        </div>
                                    </div>

                                    <div class="mt-3">
                                        <h5>Adicionar Dependente</h5>
                                        <div class="row g-3 mb-3">
                                            <div class="col-lg-6">
                                                <label class="form-label">Selecionar Sócio Frequente</label>
                                                <ng-select [(ngModel)]="novoDependenteSocioFrequenteId"
                                                    name="novoDependenteSocioFrequenteId" [disabled]="loading"
                                                    [clearable]="true" [searchable]="true" [closeOnSelect]="true"
                                                    placeholder="Selecione um sócio frequente como dependente"
                                                    [items]="sociosFrequentes" bindValue="id" bindLabel="nomeSocio">
                                                </ng-select>
                                            </div>
                                            <div class="col-lg-6 d-flex align-items-end">
                                                <button type="button" class="btn btn-primary w-100"
                                                    (click)="adicionarDependente()"
                                                    [disabled]="!novoDependenteSocioFrequenteId">
                                                    Adicionar Sócio como Dependente
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Indicador de carregamento -->
                    <div *ngIf="loading" class="d-flex justify-content-center my-3">
                        <div class="spinner-border text-primary" role="status">
                            <span class="visually-hidden">Carregando...</span>
                        </div>
                    </div>

                    <!-- Botões de ação -->
                    <div class="d-flex justify-content-end gap-2">
                        <button type="button" class="btn btn-light" (click)="onCancel()" [disabled]="loading">
                            <i class="ri-close-line align-bottom me-1"></i> Cancelar
                        </button>
                        <button type="submit" class="btn btn-primary" [disabled]="loading || loadingImage">
                            <i class="ri-save-line align-bottom me-1"></i> Salvar
                        </button>
                    </div>
                </form>
            </div>
            <!-- end card body -->
        </div>
        <!-- end card -->
    </div>
    <!-- end col -->
</div>
<!-- end row -->