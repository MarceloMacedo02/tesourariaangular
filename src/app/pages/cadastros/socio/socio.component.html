<!-- Start Breadcrumbs -->
<app-breadcrumbs title="Sócios" [breadcrumbItems]="breadCrumbItems"></app-breadcrumbs>
<!-- End Breadcrumbs -->

<div class="row">
  <div class="col-lg-12">
    <div class="card">
      <div class="card-header">
        <div class="d-flex gap-2">
          <h4 class="card-title mb-0 flex-grow-1">Sócios</h4>
          <div class="flex-shrink-0">
            <button type="button" class="btn btn-light" (click)="loadSocios()">
              <i class="ri-refresh-line align-bottom"></i>
            </button>
          </div>
        </div>
      </div>

      <div class="card-body">
        <!-- Filtro -->
        <div class="row g-3">
          <div class="col-xl-6">
            <div class="search-box">
              <input type="text" class="form-control" placeholder="Filtrar sócios..." [(ngModel)]="filtro"
                (input)="onFiltroChange()">
            </div>
          </div>
          <div class="col-xl-6 text-xl-end">
            <a routerLink="/pages/cadastros/socio/novo" class="btn btn-primary">
              <i class="ri-add-line align-bottom me-1"></i> Adicionar
            </a>
          </div>
        </div>

        <!-- Tabela de resultados -->
        <div class="table-responsive mt-3">
          <table class="table table-nowrap table-centered align-middle mb-0">
            <thead class="table-light">
              <tr>
                <th scope="col">Nome</th>
                <th scope="col">CPF</th>
                <th scope="col">Grau</th>
                <th scope="col">Status</th>
                <th scope="col">Data Adesão</th>
                <th scope="col">Grupo Mensalidade</th>
                <th scope="col">Ações</th>
              </tr>
            </thead>
            <tbody>
              <tr *ngFor="let socio of socios">
                <td>
                  <a [routerLink]="['/pages/cadastros/socio/editar', socio.id]" class="text-primary fw-medium" title="Editar Sócio">
                    {{ socio.nomeSocio }}
                  </a>
                </td>
                <td>{{ socio.cpf }}</td>
                <td>
                  <span class="badge bg-primary">
                    {{ getGrauSocioText(socio.grau) }}
                  </span>
                </td>
                <td>
                  <span class="badge" [ngClass]="getStatusBadgeClass(socio.status || '')">
                    {{ getStatusText(socio.status || '') }}
                  </span>
                </td>
                <td>{{ socio.dataAdesao ? (socio.dataAdesao | date:'shortDate') : '-' }}</td>
                <td>
                  <div *ngIf="socio.id && !editandoGrupoMensalidade[socio.id.toString()]">
                    <span>{{ getGrupoMensalidadeNome(socio.grupoMensalidadeId) }}</span>
                    <button class="btn btn-sm btn-outline-primary ms-2" (click)="editarGrupoMensalidade(socio)" title="Editar Grupo Mensalidade">
                      <i class="ri-edit-line"></i>
                    </button>
                  </div>
                  <div *ngIf="socio.id && editandoGrupoMensalidade[socio.id.toString()]" class="d-flex align-items-center">
                    <ng-select [(ngModel)]="socio.grupoMensalidadeId" name="grupoMensalidadeId_{{socio.id}}"
                                              [disabled]="loading" [clearable]="true" [searchable]="true"
                                              [closeOnSelect]="true" placeholder="Selecione um grupo de mensalidade"
                                              [items]="gruposMensalidade" bindValue="id" bindLabel="nomeGrupoMensalidade">
                                        </ng-select>
                    <div class="btn-group ms-2" role="group">
                      <button class="btn btn-sm btn-success" (click)="salvarGrupoMensalidade(socio)" [disabled]="loading" title="Salvar">
                        <i class="ri-check-line"></i>
                      </button>
                      <button class="btn btn-sm btn-secondary" (click)="cancelarEdicao(socio)" [disabled]="loading" title="Cancelar">
                        <i class="ri-close-line"></i>
                      </button>
                    </div>
                  </div>
                </td>
                <td>
                  <ul class="list-inline mb-0">
                    <li class="list-inline-item">
                      <a [routerLink]="['/pages/cadastros/cobrancas/socio', socio.id]" class="btn btn-soft-info btn-sm"
                        title="Visualizar Cobranças">
                        <i class="ri-file-list-fill align-bottom"></i>
                      </a>
                    </li>
                  </ul>
                </td>
              </tr>
              <tr *ngIf="loading">
                <td colspan="7" class="text-center">
                  <div class="d-flex justify-content-center">
                    <div class="spinner-border text-primary" role="status">
                      <span class="visually-hidden">Carregando...</span>
                    </div>
                  </div>
                </td>
              </tr>
              <tr *ngIf="!loading && (!page.content || page.content.length === 0)">
                <td colspan="7" class="text-center">
                  Nenhum sócio encontrado.
                </td>
              </tr>
            </tbody>
          </table>
        </div>

        <!-- Paginação -->
        <div class="row g-0 mt-3 align-items-center" *ngIf="!loading && page.totalElements > 0">
          <div class="col-sm-6">
            <div class="text-muted">
              Mostrando <b>{{ page.number * page.size + 1 }}</b> a
              <b>{{ page.number * page.size + page.numberOfElements }}</b> de
              <b>{{ page.totalElements }}</b> resultados
            </div>
          </div>
          <div class="col-sm-6">
            <ul class="pagination pagination-separated justify-content-end mb-0">
              <li class="page-item" [class.disabled]="currentPage === 0">
                <a class="page-link" href="javascript:void(0)" (click)="onPageChange(currentPage - 1)">
                  Anterior
                </a>
              </li>

              <li class="page-item" [class.active]="currentPage === 0">
                <a class="page-link" href="javascript:void(0)" (click)="onPageChange(0)">1</a>
              </li>

              <!-- Exibir páginas intermediárias se necessário -->
              <li class="page-item disabled" *ngIf="currentPage > 3">
                <span class="page-link">...</span>
              </li>

              <li *ngFor="let pageNr of getVisiblePages(); let i = index" class="page-item"
                [class.active]="currentPage === pageNr" [class.disabled]="pageNr === -1">
                <span class="page-link" *ngIf="pageNr === -1">...</span>
                <a class="page-link" href="javascript:void(0)" (click)="onPageChange(pageNr)" *ngIf="pageNr !== -1">{{
                  pageNr + 1 }}</a>
              </li>

              <li class="page-item disabled" *ngIf="currentPage < page.totalPages - 4">
                <span class="page-link">...</span>
              </li>

              <li class="page-item" [class.active]="currentPage === page.totalPages - 1" *ngIf="page.totalPages > 1">
                <a class="page-link" href="javascript:void(0)" (click)="onPageChange(page.totalPages - 1)">
                  {{ page.totalPages }}
                </a>
              </li>

              <li class="page-item" [class.disabled]="currentPage === page.totalPages - 1">
                <a class="page-link" href="javascript:void(0)" (click)="onPageChange(currentPage + 1)">
                  Próximo
                </a>
              </li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>