<div class="page-content">
  <div class="container-fluid">
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header align-items-center d-flex">
            <h4 class="card-title mb-0 flex-grow-1">Quitação de Transação de Crédito</h4>
          </div>
          <div class="card-body">
            <form [formGroup]="movimentacaoForm" (ngSubmit)="onSubmit()">
              <div class="row">
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="descricao" class="form-label">Descrição</label>
                    <input 
                      type="text" 
                      class="form-control" 
                      id="descricao"
                      formControlName="descricao"
                      placeholder="Descrição da transação de crédito">
                  </div>
                  
                  <div class="mb-3">
                    <label for="valor" class="form-label">Valor</label>
                    <input 
                      type="number" 
                      class="form-control" 
                      id="valor"
                      formControlName="valor"
                      placeholder="0,00"
                      step="0.01"
                      min="0">
                  </div>
                  
                  <div class="mb-3">
                    <label for="dataMovimento" class="form-label">Data da Movimentação</label>
                    <input 
                      type="date" 
                      class="form-control" 
                      id="dataMovimento"
                      formControlName="dataMovimento">
                  </div>
                  
                  <div class="mb-3">
                    <label for="rubricaId" class="form-label">Rubrica</label>
                    <select 
                      class="form-select" 
                      id="rubricaId"
                      formControlName="rubricaId">
                      <option value="">Selecione uma rubrica</option>
                      <option *ngFor="let rubrica of referencias.rubricas" [value]="rubrica.id">
                        {{ rubrica.descricao }}
                      </option>
                    </select>
                  </div>
                  
                  <div class="mb-3">
                    <label for="categoriaId" class="form-label">Categoria</label>
                    <select 
                      class="form-select" 
                      id="categoriaId"
                      formControlName="categoriaId">
                      <option value="">Selecione uma categoria</option>
                      <option *ngFor="let categoria of categorias" [value]="categoria.id">
                        {{ categoria.descricao }}
                      </option>
                    </select>
                  </div>
                </div>
                
                <div class="col-md-6">
                  <div class="mb-3">
                    <label for="socioId" class="form-label">Sócio (Opcional)</label>
                    <ng-select
                      [items]="socios"
                      bindLabel="nomeSocio"
                      bindValue="id"
                      placeholder="Selecione um sócio"
                      formControlName="socioId"
                      [loading]="carregandoSocios"
                      (change)="onSocioChange($event)"
                      [clearable]="true">
                      <ng-option *ngFor="let socio of socios" [value]="socio.id">
                        {{ socio.nomeSocio }}
                      </ng-option>
                    </ng-select>
                    <div class="form-text">Opcional - selecionar sócio para associar a transação</div>
                  </div>
                  
                  <div class="mb-3" *ngIf="movimentacaoForm.get('socioId')?.value">
                    <label class="form-label">Cobranças do Sócio</label>
                    
                    <!-- Cobranças de mensalidade -->
                    <div class="mb-3" *ngIf="cobrancasMensais.length > 0">
                      <h6>Cobranças de Mensalidade</h6>
                      <div class="list-group">
                        <div 
                          class="list-group-item" 
                          *ngFor="let cobranca of cobrancasMensais">
                          <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ cobranca.descricao }}</h6>
                            <small>{{ cobranca.dataVencimento | date:'dd/MM/yyyy' }}</small>
                          </div>
                          <p class="mb-1">R$ {{ cobranca.valor | number:'1.2-2' }}</p>
                          <small>Status: {{ cobranca.status }}</small>
                        </div>
                      </div>
                    </div>
                    
                    <!-- Cobranças de rubricas -->
                    <div class="mb-3" *ngIf="cobrancasRubricas.length > 0">
                      <h6>Cobranças de Rubricas</h6>
                      <div class="list-group">
                        <div 
                          class="list-group-item" 
                          *ngFor="let cobranca of cobrancasRubricas">
                          <div class="d-flex w-100 justify-content-between">
                            <h6 class="mb-1">{{ cobranca.descricao }}</h6>
                            <small>{{ cobranca.dataVencimento | date:'dd/MM/yyyy' }}</small>
                          </div>
                          <p class="mb-1">R$ {{ cobranca.valor | number:'1.2-2' }}</p>
                          <small>Status: {{ cobranca.status }}</small>
                        </div>
                      </div>
                    </div>
                    
                    <div *ngIf="!cobrancasMensais.length && !cobrancasRubricas.length">
                      <p class="text-muted">Nenhuma cobrança encontrada para este sócio.</p>
                    </div>
                  </div>
                  
                  <div class="mb-3">
                    <label for="centroCustoId" class="form-label">Centro de Custo</label>
                    <select 
                      class="form-select" 
                      id="centroCustoId"
                      formControlName="centroCustoId">
                      <option value="">Selecione um centro de custo</option>
                      <option *ngFor="let centro of referencias.centrosCusto" [value]="centro.id">
                        {{ centro.descricao }}
                      </option>
                    </select>
                  </div>
                  
                  <div class="mb-3">
                    <label for="observacao" class="form-label">Observações</label>
                    <textarea 
                      class="form-control" 
                      id="observacao"
                      formControlName="observacao"
                      rows="3"
                      placeholder="Observações adicionais sobre a transação"></textarea>
                  </div>
                  
                  <!-- Botão para adicionar cobrança de rubrica -->
                  <div class="mb-3" *ngIf="movimentacaoForm.get('socioId')?.value">
                    <button 
                      type="button" 
                      class="btn btn-outline-primary btn-sm"
                      (click)="adicionarCobrancaRubrica()">
                      + Adicionar Cobrança de Rubrica
                    </button>
                  </div>
                  
                  <div class="d-flex gap-2">
                    <button 
                      type="submit" 
                      class="btn btn-success"
                      [disabled]="movimentacaoForm.invalid || carregando">
                      <span *ngIf="carregando" class="spinner-border spinner-border-sm me-2" role="status"></span>
                      {{ carregando ? 'Salvando...' : 'Registrar Movimentação' }}
                    </button>
                    <button 
                      type="button" 
                      class="btn btn-secondary"
                      (click)="cancelar()">
                      Cancelar
                    </button>
                  </div>
                </div>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>