<!-- Start Breadcrumbs -->
<app-breadcrumbs [title]="transacao() ? 'Editar Transação de Crédito' : 'Nova Transação de Crédito'"
    [breadcrumbItems]="breadCrumbItems"></app-breadcrumbs>
<!-- End Breadcrumbs -->

<!-- Card com detalhes da transação -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">Detalhes da Transação</h4>
            </div>
            <div class="card-body">
                <div class="row g-3">
                    <!-- Descrição da transação no início do card -->
                    <div class="col-lg-12">
                        <div class="mb-3">
                            <label for="descricaoTransacao" class="form-label">Descrição</label>
                            <input type="text" class="form-control" id="descricaoTransacao"
                                [value]="transacao()?.descricao" disabled>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="mb-3">
                            <label for="idTransacao" class="form-label">ID</label>
                            <input type="text" class="form-control" id="idTransacao" [value]="transacao()?.id" disabled>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="mb-3">
                            <label for="statusTransacao" class="form-label">Status</label>
                            <input type="text" class="form-control" id="statusTransacao" [value]="transacao()?.status"
                                disabled>
                        </div>
                    </div>

                    <div class="col-lg-3">
                        <div class="mb-3">
                            <label for="pagador" class="form-label">Fornecedor ou Sócio</label>
                            <input type="text" class="form-control" id="pagador"
                                [value]="transacao()?.socio?.nomeSocio || transacao()?.fornecedor?.nomeFornecedor || 'N/A'"
                                disabled>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="mb-3">
                            <label for="valor" class="form-label">Valor</label>
                            <input type="text" class="form-control" id="valor"
                                [value]="transacao()?.valor ? (transacao()?.valor | currency:'BRL':'symbol':'1.2-2':'pt') : ''"
                                disabled>
                        </div>
                    </div>

                    <div class="col-lg-2">
                        <div class="mb-3">
                            <label for="dataVencimento" class="form-label">Data Vencimento</label>
                            <input type="text" class="form-control" id="dataVencimento"
                                [value]="transacao()?.dataVencimento | date:'dd/MM/yyyy'" disabled>
                        </div>
                    </div>

                    <div class="col-lg-3">
                        <div class="mb-3">
                            <label for="dataPagamento" class="form-label">Data Pagamento</label>
                            <input type="text" class="form-control" id="dataPagamento"
                                [value]="transacao()?.dataPagamento ? (transacao()?.dataPagamento | date:'dd/MM/yyyy') : 'N/A'"
                                disabled>
                        </div>
                    </div>

                    <div class="col-lg-12">
                        <div class="mb-3" *ngIf="!transacao()?.socio">
                            <button (click)="isAssociarSocioModalOpen.set(true)" class="btn btn-primary">
                                Associar Sócio à Transação
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">{{ transacao() ? 'Editar Transação de Crédito' : 'Nova Transação de Crédito'
                    }}</h4>
            </div>
            <div class="card-body">
                <!-- Erros de validação -->
                <div *ngIf="errors.length > 0" class="alert alert-danger">
                    <ul class="mb-0">
                        <li *ngFor="let error of errors">{{ error }}</li>
                    </ul>
                </div>

                <!-- Abas para organizar os dados -->
                <ul class="nav nav-tabs nav-tabs-custom nav-justified" role="tablist">
                    <li class="nav-item">
                        <a class="nav-link" [class.active]="activeTab === 'contas-mensalidade'"
                            (click)="activeTab = 'contas-mensalidade'" role="tab" style="cursor: pointer;">
                            <span class="d-block d-sm-none">Mensalidade</span>
                            <span class="d-none d-sm-block">Mensalidades</span>
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" [class.active]="activeTab === 'outras-rubricas'"
                            (click)="activeTab = 'outras-rubricas'" role="tab" style="cursor: pointer;">
                            <span class="d-block d-sm-none">Rubricas</span>
                            <span class="d-none d-sm-block">Outras Rubricas</span>
                        </a>
                    </li>
                </ul>

                <div class="tab-content p-4">

                    <!-- Cobranças em Aberto (Outras Rubricas) -->
                    <div class="tab-pane" [class.active]="activeTab === 'outras-rubricas'"
                        [class.show]="activeTab === 'outras-rubricas'">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <h5 class="card-title mb-0">Cobranças em Aberto (Outras Rubricas)</h5>
                            <button class="btn btn-success" (click)="isOutrasRubricasModalOpen.set(true)">
                                <i class="fas fa-plus"></i> Nova Cobrança
                            </button>
                            <span class="text-lg font-bold text-blue-600">
                                Total Selecionado: {{ totalOutrasRubricasSelecionado() |
                                currency:'BRL':'symbol':'1.2-2':'pt' }}
                            </span>
                        </div>

                        <div class="table-responsive mt-3">
                            <table class="table table-nowrap table-centered align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>
                                            <input type="checkbox" class="form-check-input"
                                                (change)="toggleAllSelection('outras-rubricas')"
                                                [checked]="isAllSelected('outras-rubricas')">
                                        </th>
                                        <th>Sócio/Dependente</th>
                                        <th>Descrição</th>
                                        <th>Vencimento</th>
                                        <th>Valor Original</th>
                                        <th>Tipo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let cobranca of contasOutrasRubricas()">
                                        <td>
                                            <input type="checkbox"
                                                [checked]="selectedCobrancaIds().includes(cobranca.id)"
                                                (change)="toggleSelection(cobranca.id, cobranca.valor)"
                                                class="form-check-input">
                                        </td>
                                        <td>{{ cobranca.socioNome || 'N/A' }}</td>
                                        <td>{{ cobranca.descricao }}</td>
                                        <td>{{ cobranca.dataVencimento | date:'dd/MM/yyyy' }}</td>
                                        <td class="text-green-600 font-medium">{{ cobranca.valor |
                                            currency:'BRL':'symbol':'1.2-2':'pt' }}</td>
                                        <td>{{ cobranca.tipoCobranca }}</td>
                                        <td>
                                            <button class="btn btn-sm btn-outline-primary me-1"
                                                (click)="openEditarCobrancaOutrasRubricas(cobranca)">
                                                <i class="fas fa-edit"></i> Editar
                                            </button>
                                        </td>
                                    </tr>
                                    <tr *ngIf="contasOutrasRubricas().length === 0">
                                        <td colspan="7" class="text-center text-muted">
                                            Nenhuma cobrança de Outras Rubricas em aberto encontrada.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Cobranças em Aberto (Mensalidade) -->
                    <div class="tab-pane" [class.active]="activeTab === 'contas-mensalidade'"
                        [class.show]="activeTab === 'contas-mensalidade'">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="card-title mb-0">Cobranças em Aberto (Mensalidade)</h5>
                            <span class="text-lg font-bold text-blue-600">
                                Total Selecionado: {{ totalMensalidadeSelecionado() |
                                currency:'BRL':'symbol':'1.2-2':'pt' }}
                            </span>
                        </div>

                        <div class="table-responsive mt-3">
                            <table class="table table-nowrap table-centered align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>
                                            <input type="checkbox" class="form-check-input"
                                                (change)="toggleAllSelection('contas-mensalidade')"
                                                [checked]="isAllSelected('contas-mensalidade')">
                                        </th>
                                        <th>Sócio</th>
                                        <th>Descrição</th>
                                        <th>Vencimento</th>
                                        <th>Valor Original</th>
                                        <th>Tipo</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr *ngFor="let cobranca of contasMensalidade()">
                                        <td>
                                            <input type="checkbox"
                                                [checked]="selectedCobrancaIds().includes(cobranca.id)"
                                                (change)="toggleSelection(cobranca.id, cobranca.valor)"
                                                class="form-check-input">
                                        </td>
                                        <td>{{ cobranca.socioNome || 'N/A' }}</td>
                                        <td>{{ cobranca.descricao }}</td>
                                        <td>{{ cobranca.dataVencimento | date:'dd/MM/yyyy' }}</td>
                                        <td class="text-green-600 font-medium">{{ cobranca.valor |
                                            currency:'BRL':'symbol':'1.2-2':'pt' }}</td>
                                        <td>{{ cobranca.tipoCobranca }}</td>
                                    </tr>
                                    <tr *ngIf="contasMensalidade().length === 0">
                                        <td colspan="6" class="text-center text-muted">
                                            Nenhuma cobrança de Mensalidade em aberto encontrada.
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>



                </div>
            </div>
        </div>
    </div>
</div>

<!-- Card de Baixa da Transação na parte inferior -->
<div class="row mt-4">
    <div class="col-lg-12">
        <div class="card">
            <div class="card-header">
                <h4 class="card-title mb-0">Baixa da Transação</h4>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-6">
                        <div class="card border border-dashed border-primary">
                            <div class="card-body text-center">
                                <h5 class="card-title">Total de Contas a Receber Selecionadas</h5>
                                <div class="display-4 text-primary font-weight-bold py-3">
                                    {{ grandTotalReceber() | currency:'BRL':'symbol':'1.2-2':'pt' }}
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="col-lg-6">
                        <div class="card">
                            <div class="card-body">
                                <form (ngSubmit)="quitarCobrancas()" class="row g-3">
                                    <div class="col-12">
                                        <label for="contaFinanceiraSelect" class="form-label">Conta Financeira</label>
                                        <select id="contaFinanceiraSelect" [(ngModel)]="selectedContaFinanceiraId"
                                            name="contaFinanceiraId" required class="form-control">
                                            <option [ngValue]="null">Selecione a Conta Financeira</option>
                                            <option *ngFor="let conta of contasFinanceiras()" [ngValue]="conta.id">{{
                                                conta.nome }}</option>
                                        </select>
                                    </div>

                                    <div class="col-12">
                                        <div [ngClass]="isTotalMatching() ? 'bg-success text-white' : 'bg-danger text-white'"
                                            class="p-3 rounded-lg text-center">
                                            <div *ngIf="isTotalMatching()">
                                                Valor da Transação ({{ transacao()?.valor |
                                                currency:'BRL':'symbol':'1.2-2':'pt' }})
                                                <strong>IGUALA</strong>
                                                o Total Selecionado!
                                            </div>
                                            <div *ngIf="!isTotalMatching()">
                                                Valor da Transação ({{ transacao()?.valor |
                                                currency:'BRL':'symbol':'1.2-2':'pt' }})
                                                <strong>NÃO IGUALA</strong>
                                                o Total Selecionado. Diferença: {{ totalDiferenca() |
                                                currency:'BRL':'symbol':'1.2-2':'pt' }}
                                            </div>
                                        </div>
                                    </div>

                                    <div class="col-12">
                                        <button type="submit" [disabled]="!isQuitarButtonEnabled()"
                                            [ngClass]="isQuitarButtonEnabled() ? 'btn btn-primary' : 'btn btn-secondary disabled'"
                                            class="btn w-100">
                                            Quitar Cobranças Selecionadas
                                        </button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Componente de Modais Reutilizáveis -->
<app-modais-transacoes
  [isAssociarSocioModalOpen]="isAssociarSocioModalOpen"
  [isNovaContaReceberModalOpen]="isNovaContaReceberModalOpen"
  [isEditContaReceberModalOpen]="isEditContaReceberModalOpen"
  [isExcluirContaReceberModalOpen]="isExcluirContaReceberModalOpen"
  [isOutrasRubricasModalOpen]="isOutrasRubricasModalOpen"
  [socios]="socios"
  [rubricas]="rubricas"
  [transacao]="transacao"
  (associarSocio)="onAssociarSocio($event)"
  (salvarNovaConta)="onSalvarNovaConta($event)"
  (salvarEdicaoConta)="onSalvarEdicaoConta($event)"
  (confirmarExclusao)="onConfirmarExclusao()"
  (salvarNovaCobrancaOutrasRubricas)="onSalvarNovaCobrancaOutrasRubricas($event)">
</app-modais-transacoes>